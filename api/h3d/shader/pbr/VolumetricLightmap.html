<!DOCTYPE html>
<html lang="en"><!-- use theme color or fallback -->
<!--use textcolor from settings, otherwise create a contrasting color to theme color-->
<head><meta charset="utf-8"/><link href="../../../bootstrap/css/bootstrap.min.css" rel="stylesheet"/><link href="../../../bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet"/><link href="../../../bootstrap/css/bootstrap-select.min.css" rel="stylesheet"/><link href="../../../../css/styles.min.css" rel="stylesheet"/><link href="../../../styles.css" rel="stylesheet"/><script type="text/javascript">var dox = {rootPath: "../../../",platforms: ["heaps"]};</script><title>h3d.shader.pbr.VolumetricLightmap - Heaps.io Game Engine</title><script src="../../../jquery-1.9.1.min.js"></script><script src="../../../bootstrap/js/bootstrap.min.js"></script><script src="../../../bootstrap/js/bootstrap-select.min.js"></script><script type="text/javascript" src="../../../nav.js"></script><script type="text/javascript" src="../../../index.js"></script>   <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en"/><link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed:300" rel="stylesheet"/></head><div class='api-documentation'><body><a href="https://github.com/HeapsIO/" class="fork-button"><img src="../../../../img/fork-on-github.png" alt="Fork Heaps on GitHub"/></a><header class="header-documentation"><nav class="top-nav"><a href="../../../../" class="button">Home</a><a href="../../../../about.html" class="button">About</a><a href="../../../../samples/" class="button">Samples</a><a href="../../../../documentation/" class="button">Documentation</a><a href="../../../" class="button disabled">API</a><a href="https://community.heaps.io/" class="button" target="_blank">Community</a></nav></header><div class="container main-content"><div class="row-fluid"><div class="span3"><div class="well sidebar-nav"><form class="form-search" id="searchForm"><div class="input-prepend input-block-level"><span class="add-on"><i class="icon-search"></i></span><input id="search" type="text" placeholder="Filter (Ctrl+P)" autocomplete="off"/></div></form></div><div class="well sidebar-nav" id="explorer"><div id="nav"></div></div></div><div class="span9"><div class="page-header"><span class="viewsource"><a href="https://github.com/HeapsIO/heaps/blob/master/h3d/shader/pbr/VolumetricLightmap.hx" class="btn btn-medium"><i class="fa fa-eye"></i> View source</a></span><h1><small>class</small> VolumetricLightmap</h1><h4><small>package <a href="../../../h3d/shader/pbr/index.html">h3d.shader.pbr</a></small></h4><h4><small>extends <a class="type" title="" href="../../../hxsl/Shader.html">Shader</a></small></h4>    <span class="label label-meta label-meta-directlyUsed" title="@:directlyUsed metadata">@:directlyUsed</span><span class="label label-meta label-meta-src" title="@:src metadata">@:src({
	function getCoef(shCoords:Vec3, band:Int):Vec3 {
		var u = (shCoords.x + band * lightmapSize.x) * texelSize.x + texelSize.x / 2.0;
		var v = (shCoords.y + shCoords.z * lightmapSize.y) * texelSize.y + texelSize.y / 2.0;
		return lightProbeTexture.get(vec2(u, v)).rgb;
	};
	function getCoefFinal(band:Int):Vec3 {
		var p00 = mix(getCoef(p000, band), getCoef(p100, band), dist.x);
		var p01 = mix(getCoef(p001, band), getCoef(p101, band), dist.x);
		var p10 = mix(getCoef(p010, band), getCoef(p110, band), dist.x);
		var p11 = mix(getCoef(p011, band), getCoef(p111, band), dist.x);
		var p0 = mix(p00, p10, dist.y);
		var p1 = mix(p01, p11, dist.y);
		var p = mix(p0, p1, dist.z);
		return p;
	};
	function computeIrradiance(norm:Vec3):Vec3 {
		var c1 = 0.429043;
		var c2 = 0.511664;
		var c3 = 0.743125;
		var c4 = 0.886227;
		var c5 = 0.247708;
		var irradiance = vec3(0, 0, 0);
		if (ORDER &gt;= 1) {
			var L00 = getCoefFinal(0);
			irradiance += c4 * L00;
		};
		if (ORDER &gt;= 2) {
			var L1n1 = getCoefFinal(1);
			var L10 = getCoefFinal(2);
			var L11 = getCoefFinal(3);
			irradiance += 2 * c2 * (L11 * norm.x + L1n1 * norm.y + L10 * norm.z);
		};
		if (ORDER &gt;= 3) {
			var L2n2 = getCoefFinal(4);
			var L2n1 = getCoefFinal(5);
			var L20 = getCoefFinal(6);
			var L21 = getCoefFinal(7);
			var L22 = getCoefFinal(8);
			irradiance += c1 * L22 * (norm.x * norm.x - norm.y * norm.y) + c3 * L20 * (norm.z * norm.z) - c5 * L20 + 2 * c1 * (L2n2 * (norm.x * norm.y) + L21 * (norm.x * norm.z) + L2n1 * (norm.y * norm.z));
		};
		return irradiance / 3.14;
	};
	function getLightProbeIndex(coords:Vec3):Int {
		return int(floor(coords.x + lightmapSize.x * coords.y + lightmapSize.y * lightmapSize.x * coords.z));
	};
	function getVoxelCoords(pos:Vec3):Vec3 {
		posLightmapSpace = (vec4(pos, 1) * lightmapInvPos).xyz;
		return floor(posLightmapSpace * (lightmapSize - vec3(1, 1, 1)));
	};
	function getLightProbePosition(coords:Vec3):Vec3 {
		return coords * voxelSize;
	};
	function getPixelPosition():Vec3 {
		var uv2 = (screenUV - 0.5) * vec2(2, -2);
		var temp = vec4(uv2, depth, 1) * cameraInverseViewProj;
		var originWS = temp.xyz / temp.w;
		return originWS;
	};
	function getClampedCoords(coords:Vec3):Vec3 {
		return min(lightmapSize - vec3(1, 1, 1), max(vec3(0, 0, 0), coords));
	};
	@const var ORDER:Int;
	@param var lightProbeTexture:Sampler2D;
	@param var lightmapInvPos:Mat4;
	@param var lightmapSize:Vec3;
	@param var voxelSize:Vec3;
	@param var strength:Float;
	@param var cameraInverseViewProj:Mat4;
	@param var cameraPos:Vec3;
	var transformedPosition:Vec3;
	var screenUV:Vec2;
	var depth:Float;
	var normal:Vec3;
	var position:Vec3;
	var posLightmapSpace:Vec3;
	var voxelCoords:Vec3;
	var albedo:Vec3;
	var occlusion:Float;
	var roughness:Float;
	var metalness:Float;
	var probeCount:Float;
	var coefCount:Float;
	var texelSize:Vec2;
	var dist:Vec3;
	var p000:Vec3;
	var p100:Vec3;
	var p010:Vec3;
	var p001:Vec3;
	var p110:Vec3;
	var p101:Vec3;
	var p011:Vec3;
	var p111:Vec3;
	var output:{ var color : Vec4};
	function fragment() {
		position = getPixelPosition();
		voxelCoords = getVoxelCoords(position);
		probeCount = lightmapSize.x * lightmapSize.y * lightmapSize.z;
		coefCount = float(ORDER * ORDER);
		texelSize = vec2(1 / (lightmapSize.x * coefCount), 1 / (lightmapSize.y * lightmapSize.z));
		if (posLightmapSpace.x &lt; 0 || posLightmapSpace.y &lt; 0 || posLightmapSpace.z &lt; 0 || posLightmapSpace.x &gt; 1 || posLightmapSpace.y &gt; 1 || posLightmapSpace.z &gt; 1) discard;
		p000 = getClampedCoords(voxelCoords + vec3(0, 0, 0));
		p100 = getClampedCoords(voxelCoords + vec3(1, 0, 0));
		p010 = getClampedCoords(voxelCoords + vec3(0, 1, 0));
		p001 = getClampedCoords(voxelCoords + vec3(0, 0, 1));
		p110 = getClampedCoords(voxelCoords + vec3(1, 1, 0));
		p101 = getClampedCoords(voxelCoords + vec3(1, 0, 1));
		p011 = getClampedCoords(voxelCoords + vec3(0, 1, 1));
		p111 = getClampedCoords(voxelCoords + vec3(1, 1, 1));
		var voxelPos = (voxelCoords) / (lightmapSize - vec3(1, 1, 1));
		dist = (posLightmapSpace - voxelPos) * (lightmapSize - vec3(1, 1, 1));
		var irradiance:Vec3 = computeIrradiance(normal) * min(vec3(1), albedo) * occlusion;
		var NdV = dot(normal, normalize(cameraPos - position));
		var F0 = mix(vec3(0.04), albedo, metalness);
		var F = F0 + (max(vec3(1 - roughness), F0) - F0) * exp2((-5.55473 * NdV - 6.98316) * NdV);
		var indirect = (irradiance * (1 - metalness) * (1 - F)) * strength;
		output.color.rgb += indirect;
	};
})</span><span class="label label-meta label-meta-build" title="@:build metadata">@:build(hxsl.Macros.buildShader())</span><span class="label label-meta label-meta-autoBuild" title="@:autoBuild metadata">@:autoBuild(hxsl.Macros.buildShader())</span></div><div class="body"><div class="doc doc-main"><p></p></div><h3 class="section">Constructor</h3><div class="fields"><div class="field "><a name="new"></a><h3 class="anchor"><code><a href="#new"><span class="identifier">new</span></a>()</code></h3><div class="doc"><p></p></div></div></div><h3 class="section">Variables</h3><div class="fields"><div class="field "><a name="ORDER"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#ORDER"><span class="identifier">ORDER</span></a>:<span class="type">Int</span></code></h3><div class="doc"><p></p></div></div><div class="field "><a name="cameraInverseViewProj"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#cameraInverseViewProj"><span class="identifier">cameraInverseViewProj</span></a>:<a class="type" title="" href="../../../hxsl/Matrix.html">Matrix</a></code></h3><div class="doc"><p></p></div></div><div class="field "><a name="cameraPos"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#cameraPos"><span class="identifier">cameraPos</span></a>:<a class="type" title="" href="../../../hxsl/Vec.html">Vec</a></code></h3><div class="doc"><p></p></div></div><div class="field "><a name="lightProbeTexture"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#lightProbeTexture"><span class="identifier">lightProbeTexture</span></a>:<a class="type" title="" href="../../../hxsl/Sampler2D.html">Sampler2D</a></code></h3><div class="doc"><p></p></div></div><div class="field "><a name="lightmapInvPos"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#lightmapInvPos"><span class="identifier">lightmapInvPos</span></a>:<a class="type" title="" href="../../../hxsl/Matrix.html">Matrix</a></code></h3><div class="doc"><p></p></div></div><div class="field "><a name="lightmapSize"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#lightmapSize"><span class="identifier">lightmapSize</span></a>:<a class="type" title="" href="../../../hxsl/Vec.html">Vec</a></code></h3><div class="doc"><p></p></div></div><div class="field "><a name="strength"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#strength"><span class="identifier">strength</span></a>:<span class="type">Float</span></code></h3><div class="doc"><p></p></div></div><div class="field "><a name="voxelSize"></a><h3 class="anchor"><code><a href="../../../h3d/shader/pbr/VolumetricLightmap.html#voxelSize"><span class="identifier">voxelSize</span></a>:<a class="type" title="" href="../../../hxsl/Vec.html">Vec</a></code></h3><div class="doc"><p></p></div></div></div><h3 class="section">Methods</h3><div class="fields"></div>  <div class="inherited-fields well"><h3 class="section">Inherited Variables</h3><div class="fields"><h4><a href="#" class="expand-button"><i class="fa fa-arrow-circle-o-right"></i></a> Defined by <a class="type" title="" href="../../../hxsl/Shader.html">Shader</a></h4><div style="display:none"><div class="field "><a name="priority"></a><h3 class="anchor"><code><span class="label">read only</span><a href="../../../hxsl/Shader.html#priority"><span class="identifier">priority</span></a>:<span class="type">Int</span></code></h3><div class="doc"><p></p></div></div></div></div><h3 class="section">Inherited Methods</h3><div class="fields"><h4><a href="#" class="expand-button"><i class="fa fa-arrow-circle-o-right"></i></a> Defined by <a class="type" title="" href="../../../hxsl/Shader.html">Shader</a></h4><div style="display:none"><div class="field "><a name="setPriority"></a><h3 class="anchor"><code><a href="#setPriority"><span class="identifier">setPriority</span></a>(<span style="white-space:nowrap">v:<span class="type">Int</span></span>):<span class="type">Void</span></code></h3><div class="doc"><p>Shader priority should only be changed <em>before</em> the shader is added to a material.</p></div></div><div class="field "><a name="toString"></a><h3 class="anchor"><code><a href="#toString"><span class="identifier">toString</span></a>():<span class="type">String</span></code></h3><div class="doc"><p></p></div></div></div></div></div></div></div></div></div><footer><div class="container row"><div class="col-5"><a href="../../../../"><img src="../../../../img/logo.svg"/></a></div><div class="col-3 links"><h3>Heaps.io</h3><p>Heaps is an open source and multi-platform toolkit to create 2D and 3D games.</p><a href="https://lib.haxe.org/p/heaps">Download</a><a href="../../../../about.html">About</a><a href="../../../../api">API</a><a href="https://github.com/HeapsIO/">Contribute</a><a href="https://discordapp.com/channels/162395145352904705/501408700142059520">Community</a></div><div class="col-1">&nbsp;</div><div class="col-3 links"><h3>Haxe</h3><p>Haxe is an open source and cross-platform language and toolkit.</p><a href="https://haxe.org">About</a><a href="https://haxe.org/use-cases">Use cases</a><a href="https://haxe.org/documentation/introduction/">Learn</a><a href="https://haxe.org/foundation">Haxe Foundation</a></div></div><div class="copyright">&copy; 2020 <a href="https://haxe.org/foundation/">Haxe Foundation</a>| <a href="https://github.com/HeapsIO/heaps/blob/master/h3d/shader/pbr/VolumetricLightmap.hx">Contribute to this page</a>| <a href="https://feathericons.com/" rel="nofollow">Feather open source icons</a></div></footer></div><script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script><script src="../../..//highlighter.js"></script><link href="../../../highlighter.css" rel="stylesheet"/></body></html>